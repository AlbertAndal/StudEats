#!/bin/bash

# Laravel Cloud Deployment Hook - StudEats
# This script runs automatically during Laravel Cloud deployment

set -e  # Exit on error, but we'll handle errors gracefully

echo "ğŸš€ StudEats Laravel Cloud Deployment Started"
echo "============================================"
echo "Timestamp: $(date)"

# Function to run commands safely
safe_run() {
    echo "â¤ Running: $1"
    if eval "$1"; then
        echo "  âœ… Success"
    else
        echo "  âš ï¸ Failed (continuing...)"
    fi
}

# CRITICAL: Create required directories FIRST
echo ""
echo "ğŸ“ Creating Critical Directories"
echo "--------------------------------"
safe_run "mkdir -p storage/framework/cache"
safe_run "mkdir -p storage/framework/sessions"  
safe_run "mkdir -p storage/framework/views"
safe_run "mkdir -p storage/logs"
safe_run "mkdir -p bootstrap/cache"

# Set proper permissions
echo ""
echo "ğŸ”’ Setting Permissions"
echo "---------------------"
safe_run "chmod -R 755 storage/"
safe_run "chmod -R 755 bootstrap/cache/"

# Clear caches (skip view:clear to avoid the error)
echo ""
echo "ğŸ§¹ Clearing Caches"
echo "------------------"
safe_run "php artisan config:clear"
safe_run "php artisan cache:clear"
safe_run "php artisan route:clear"

# Skip the problematic view:clear command entirely
echo "â¤ Skipping view:clear (causes Laravel Cloud deployment failure)"
echo "  âœ… View cache directory already created above"

# Database operations
echo ""
echo "ğŸ—„ï¸ Database Operations"
echo "---------------------"
safe_run "php artisan migrate --force --no-interaction"

# Seed essential data
echo ""
echo "ğŸŒ± Seeding Data"
echo "---------------"
safe_run "php artisan db:seed --class=AdminSeeder --force"

# Create storage link
echo ""
echo "ğŸ”— Storage Link"
echo "---------------"
safe_run "php artisan storage:link --force"

# Cache for production (skip view:cache too since view:clear failed)
echo ""
echo "âš¡ Production Caching"
echo "--------------------"
safe_run "php artisan config:cache"
safe_run "php artisan route:cache"
echo "â¤ Skipping view:cache (view directory might not be stable)"

# Final health check
echo ""
echo "ğŸ¥ Health Check"
echo "---------------"
echo "â¤ Testing database connection..."
if php artisan tinker --execute="try { DB::connection()->getPdo(); echo 'Database: OK'; } catch(Exception \$e) { echo 'Database: ERROR - ' . \$e->getMessage(); }" 2>/dev/null; then
    echo "  âœ… Database connection healthy"
else
    echo "  âš ï¸ Database connection might have issues"
fi

echo ""
echo "âœ… StudEats Deployment Complete!"
echo "================================"
echo "ğŸŒ Application URL: https://studeats.laravel.cloud"
echo "ğŸ”§ Admin Login: https://studeats.laravel.cloud/admin/login"
echo ""
echo "ğŸ“§ Default Admin Credentials:"
echo "   Email: admin@studeats.com"
echo "   Password: admin123"
echo ""
echo "âš ï¸ IMPORTANT: Change admin password after first login!"
echo ""